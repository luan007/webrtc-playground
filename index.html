<html>

<head>
    <title></title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <script src='./three.min.js'></script>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
        }

        video,
        canvas {
            /* visibility: collapse; */
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: block;
            height: 100%;
            width: 100%;
        }

        canvas {
            visibility: visible;
            height: 100%;
            width: 100%;
        }
    </style>
</head>

<body>
    <video playsinline id='video'></video>
    <canvas id='canvas'></canvas>
    <!-- <button onclick='play()'>fuckin play</button> -->
    <script>
        var video = document.querySelector("#video");

        video.addEventListener("loadedmetadata", function () {
            init();
            animate();
        });

        navigator.mediaDevices
            .enumerateDevices()
            .then(function (d) {
                navigator.mediaDevices.getUserMedia(
                    {
                        video: {
                            deviceId: { exact: d[1].deviceId }
                        }
                    },
                ).then(function (stream) {
                    video.srcObject = stream;
                    video.play();


                }).catch(function (e) {
                    alert(e);
                });
            })
            .catch(function () {
                // alert("Device Enum Err");
            });



        var ctx = canvas.getContext('2d');
        canvas.height = window.innerHeight;
        canvas.width = window.innerWidth;
        // var raf = function () {
        //     requestAnimationFrame(raf);
        //     ctx.clearRect(0, 0, window.innerWidth, window.innerHeight);
        //     ctx.drawImage(video, 0, 0);
        //     doFindFeatures();
        // }
        // raf();

        var scene, camera, renderer;
        var geometry, material, mesh;

        function init() {

            scene = new THREE.Scene();

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 1, 10000);
            camera.position.z = 1000;

            geometry = new THREE.BoxGeometry(200, 200, 200);
            material = new THREE.MeshBasicMaterial({ color: 0xff0000, wireframe: true });

            mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);

            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(devicePixelRatio);
            document.body.appendChild(renderer.domElement);





            var vshader = `
                varying vec2 vUv; 
                void main()
                {
                    vUv = uv;
                    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0 );
                    gl_Position = projectionMatrix * mvPosition;
                }
                `;


            var fshader = `
            
            uniform float iGlobalTime;
            uniform sampler2D iChannel0;
            uniform vec2 iResolution;
            varying vec2 vUv;
            
            const float t = 0.03;
            
            uniform float ax[16];
            uniform float ay[16];
            //const float[] ax = float[] (0.0,   1.0,  2.0,  3.0, 3.0, 3.0, 2.0, 1.0, 0.0, -1.0, -2.0, -3.0, -3.0, -3.0, -2.0, -1.0);
            //const float[] ay = float[] (-3.0, -3.0, -2.0, -1.0, 0.0, 1.0, 2.0, 3.0, 3.0,  3.0,  2.0,  1.0,  0.0, -1.0, -2.0, -3.0);
            
            float gray( in vec4 color ) {
                return 0.299 * color.x + 0.587 * color.y + 0.114 * color.z;
            }
            
            
            float ggray( in vec2 fragCoord ) {
                vec4 cur = texture2D(iChannel0, fragCoord.xy / iResolution.xy);
                return gray(cur);
            }
            
            float corner ( in vec2 fragCoord ) {
                float x = fragCoord.x;
                float y = fragCoord.y;
                
                
                //blur
                
                
                
                //vec4 cur = texture(iChannel0, fragCoord.xy / iResolution.xy);
                
                float b = (ggray(vec2(x, y))
                           + ggray(vec2(1.0 + x, y))
                           + ggray(vec2(x - 1.0, y))
                           + ggray(vec2(x, y - 1.0))
                           + ggray(vec2(x, y + 1.0)))/ 5.0;
                
                for (float i = 0.0; i < 16.0; i++) {
                  bool darker = true;
                  bool brighter = true;
            
                  for (float j = 0.0; j < 9.0; j++) {
                    float cx = ax[int(mod((i + j), 15.0))];
                    float cy = ay[int(mod((i + j), 15.0))];
                    
                    vec4 n = texture2D(iChannel0, vec2(x + cx, y + cy) / iResolution.xy);
                    float b2 = gray(n);
                    if (b + t < b2) {
                      brighter = false;
                      if (darker == false) {
                        break;
                      }
                    }
            
                    if (b - t > b2) {
                      darker = false;
                      if (brighter == false) {
                        break;
                      }
                    }
                  }
            
                  if (brighter || darker) {
                    return 1.0;
                  }
                }
               return 0.0;
            }
            
            void main( void )
            {
                vec2 fragCoord = vUv.xy * iResolution.xy;
                float g = corner(fragCoord);
                gl_FragColor = vec4(g, g, g, 1.0);
            }
            
            
                `;

            var vtexture = new THREE.VideoTexture(video);
            vtexture.minFilter = THREE.LinearFilter;
            vtexture.magFilter = THREE.LinearFilter;
            vtexture.format = THREE.RGBFormat;

            var tuniform = {
                iGlobalTime: { type: 'f', value: 0.1 },
                iChannel0: { type: 't', value: vtexture },
                iResolution: { type: 'v2', value: new THREE.Vector2(video.videoWidth , video.videoHeight) },
                ax : { type: "fv", value: [0.0,   1.0,  2.0,  3.0, 3.0, 3.0, 2.0, 1.0, 0.0, -1.0, -2.0, -3.0, -3.0, -3.0, -2.0, -1.0] },
                ay : { type: "fv", value: [-3.0, -3.0, -2.0, -1.0, 0.0, 1.0, 2.0, 3.0, 3.0,  3.0,  2.0,  1.0,  0.0, -1.0, -2.0, -3.0] },
            };
            // tuniform.iChannel0.value.wrapS = tuniform.iChannel0.value.wrapT = THREE.ClamE;
            var mat = new THREE.ShaderMaterial({
                uniforms: tuniform,
                vertexShader: vshader,
                fragmentShader: fshader,
                side: THREE.DoubleSide
            });

            var tobject = new THREE.Mesh(new THREE.PlaneGeometry(video.videoWidth, video.videoHeight, 1, 1), mat);
            scene.add(tobject);


        }

        function animate() {

            requestAnimationFrame(animate);

            mesh.rotation.x += 0.01;
            mesh.rotation.y += 0.02;

            renderer.render(scene, camera);

        }
    </script>
</body>

</html>